<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MU Immortal - Event Timers</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #111;
    color: #eee;
    padding: 20px;
    margin: 0;
    min-height: 100vh;
    box-sizing: border-box;
    transition: background 0.3s, color 0.3s;
  }
  body.light {
    background-color: #f6f6f6;
    color: #111;
  }
  h1, h2 {
    text-align: center;
    color: #f39c12;
    margin-top: 0;
  }
  .top-bar {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 15px;
    gap: 10px;
  }
  .icon-button {
    cursor: pointer;
    font-size: 1.5em;
  }
  .event-list {
    display: flex;
    gap: 40px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .event-box {
    border: 1px solid #444;
    padding: 15px 20px;
    border-radius: 8px;
    background-color: #1e1e1e;
    min-width: 280px;
    max-width: 450px;
    flex: 1 1 350px;
    box-sizing: border-box;
  }
  body.light .event-box {
    background-color: #fff;
    border-color: #ccc;
  }
  .event {
    margin: 10px 0;
    padding: 8px 5px;
    border-bottom: 1px solid #333;
  }
  .event:last-child { border-bottom: none; }
  .event-name { font-weight: bold; font-size: 1.1em; }
  .event-time, .event-timer { font-size: 0.9em; color: #aaa; }
  .up-next, .active-events { text-align: center; margin: 20px 0; font-size: 1.2em; }
  #user-timezone { text-align: center; margin-bottom: 15px; font-size: 0.95em; }
  @media (max-width: 720px) {
    .event-list { flex-direction: column; gap: 25px; align-items: center; }
    .event-box { max-width: 100%; }
    body { padding: 15px 10px; }
  }
  @media (max-width: 400px) {
    body { font-size: 14px; }
    .event-name { font-size: 1em; }
    .event-time, .event-timer { font-size: 0.85em; }
  }
</style>
</head>
<body>
<div class="top-bar">
  <span id="day-night-toggle" class="icon-button">🌙</span>
</div>
<h1>MU Immortal - Event Timers (UTC+1)</h1>
<div id="user-timezone"></div>
<div id="up-next" class="up-next"></div>
<div id="active-events" class="active-events">No active events</div>
<div class="event-list">
  <div id="daily-events" class="event-box"><h2>Daily Events</h2></div>
  <div id="weekly-events" class="event-box"><h2>Weekly Events</h2></div>
</div>

<script>
const events = [
  { name:"Blood Castle", times: generateEvery2Hours("01:00","23:00"), duration:15, dayAbbr:[] },
  { name:"Devil Square", times: generateEvery2Hours("00:00","22:00"), duration:15, dayAbbr:[] },
  { name:"Red Dragon Invasion", times:["10:30","13:30","16:30","21:30"], duration:20, dayAbbr:[] },
  { name:"Guild Master Event", times:["11:30","19:30"], duration:30, dayAbbr:[] },
  { name:"Minion EXP +30%", times:["00:00"], duration:480, dayAbbr:[] },
  { name:"Cross-server 3v3", times:["12:00","23:30"], duration:150, dayAbbr:[] },
  { name:"Crywolf Fortress", times:["20:30"], duration:15, dayAbbr:["Mon"] },
  { name:"Chaos Castle", times:["20:00"], duration:15, dayAbbr:["Tue"] },
  { name:"Siege War", times:["20:00"], duration:30, dayAbbr:["Wed","Sat"] },
  { name:"Divine Trade Route", times:["20:00","20:30"], duration:20, dayAbbr:["Mon","Fri"] },
  { name:"Ethereal Pact", times:["11:00","15:00","19:00","23:00"], duration:20, dayAbbr:[] },
  { name:"Vulcanus", times:["20:00"], duration:15, dayAbbr:["Wed","Fri"] }
];

const notifiedEvents = new Set();
const userTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
document.getElementById("user-timezone").textContent = `Your Timezone: ${userTz}`;

function generateEvery2Hours(start,end){
  const times=[]; let [sh,sm]=start.split(":").map(Number);
  let [eh,em]=end.split(":").map(Number);
  for(let h=sh;h<=eh;h+=2){times.push(`${String(h).padStart(2,"0")}:${String(sm).padStart(2,"0")}`);}
  return times;
}

function getEventDateFromUTCPlus1(dayDate,timeStr){
  const [hour,minute]=timeStr.split(":").map(Number);
  const utcDate=new Date(Date.UTC(dayDate.getFullYear(),dayDate.getMonth(),dayDate.getDate(),hour-1,minute));
  return utcDate;
}

function getNextEventTime(event){
  const now=new Date();
  for(let offset=0;offset<8;offset++){
    const day=new Date(now); day.setDate(now.getDate()+offset);
    const dayAbbr=day.toLocaleDateString('en-US',{weekday:'short'});
    if(event.dayAbbr.length && !event.dayAbbr.includes(dayAbbr)) continue;
    for(const t of event.times){
      const dt=getEventDateFromUTCPlus1(day,t);
      if(dt>=now) return dt;
    }
  }
  return null;
}

function formatTimeLocal(date){return date.toLocaleTimeString([], {hour12:false,hour:"2-digit",minute:"2-digit"});}
function formatTimeUTCPlus1(date){let hour=date.getUTCHours()+1;if(hour>=24)hour-=24;return `${String(hour).padStart(2,"0")}:${String(date.getUTCMinutes()).padStart(2,"0")}`;}
function formatCountdown(ms){const totalSeconds=Math.floor(ms/1000);const days=Math.floor(totalSeconds/86400);const hours=Math.floor((totalSeconds%86400)/3600);const minutes=Math.floor((totalSeconds%3600)/60);return `${days}d ${hours}h ${minutes}m`;}

// Renders events in the boxes
function renderEvents(container, filterFn){
  container.querySelectorAll(".event").forEach(e=>e.remove());
  for(const event of events.filter(filterFn)){
    const nextTime=getNextEventTime(event);
    if(!nextTime) continue;
    const localTime=formatTimeLocal(nextTime);
    const utcPlus1Time=formatTimeUTCPlus1(nextTime);
    const timeDiff=nextTime-new Date();
    const div=document.createElement("div");
    div.className="event";
    div.innerHTML=`<div class="event-name">${event.name}</div>
      <div class="event-time">Local: ${localTime} | server: ${utcPlus1Time}</div>
      <div class="event-timer">Starts in: ${formatCountdown(timeDiff)}</div>`;
    container.appendChild(div);
  }
}

// ✅ Fixed Active + Up Next function
function showCurrentlyActiveAndNext(){
  const now = new Date();
  let nextEvent = null;
  let nextTime = null;
  const activeEvents = [];

  for (const event of events) {
    // Find next event
    const upcoming = getNextEventTime(event);
    if (upcoming && (!nextTime || upcoming < nextTime)) {
      nextTime = upcoming;
      nextEvent = event;
    }

    // Check active events
    for (const t of event.times) {
      const day = new Date(now);
      const eventStart = getEventDateFromUTCPlus1(day, t);
      const eventEnd = new Date(eventStart.getTime() + (event.duration || 0) * 60000);

      const eventDay = eventStart.toLocaleDateString("en-US", { weekday: "short" });
      if (event.dayAbbr.length && !event.dayAbbr.includes(eventDay)) continue;

      if (now >= eventStart && now <= eventEnd) {
        const remaining = eventEnd - now;
        activeEvents.push({ name: event.name, remaining });
      }
    }
  }

  // Up Next display
  const upNextDiv = document.getElementById("up-next");
  if (nextEvent && nextTime) {
    const local = formatTimeLocal(nextTime);
    const server = formatTimeUTCPlus1(nextTime);
    upNextDiv.textContent = `Next Event: ${nextEvent.name} at Local ${local} | Server ${server} (${formatCountdown(nextTime-now)})`;
  } else {
    upNextDiv.textContent = "No upcoming events";
  }

  // Active Events display
  const activeDiv = document.getElementById("active-events");
  if (activeEvents.length) {
    activeDiv.innerHTML = activeEvents
      .map(e => `${e.name} active for ${Math.floor(e.remaining/60000)} min`)
      .join("<br>");
  } else {
    activeDiv.textContent = "No active events";
  }

  // Notifications 5 min before
  if (nextEvent && nextTime && !notifiedEvents.has(nextEvent.name)) {
    const diff = nextTime - now;
    if (diff <= 5*60*1000 && diff > 0) {
      if (Notification.permission === "granted") {
        new Notification(`${nextEvent.name} starting in 5 minutes!`);
      }
      notifiedEvents.add(nextEvent.name);
    }
    if (diff <= 0 && notifiedEvents.has(nextEvent.name)) {
      notifiedEvents.delete(nextEvent.name);
    }
  }
}

// Theme toggle
const toggle=document.getElementById("day-night-toggle");
toggle.addEventListener("click",()=>{
  document.body.classList.toggle("light");
  toggle.textContent=document.body.classList.contains("light")?"☀️":"🌙";
});

// Initial render
renderEvents(document.getElementById("daily-events"),e=>e.dayAbbr.length===0);
renderEvents(document.getElementById("weekly-events"),e=>e.dayAbbr.length>0);
showCurrentlyActiveAndNext();

// Refresh every minute
setInterval(()=>{
  renderEvents(document.getElementById("daily-events"),e=>e.dayAbbr.length===0);
  renderEvents(document.getElementById("weekly-events"),e=>e.dayAbbr.length>0);
  showCurrentlyActiveAndNext();
},60000);

// Ask for notification permission
if(Notification.permission!=="granted" && Notification.permission!=="denied") {
  Notification.requestPermission();
}
</script>
</body>
</html>
